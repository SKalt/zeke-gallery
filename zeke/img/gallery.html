<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=windows-1252" />
    <title>Gallery of /zeke</title>
    <style>
      * {
        background-color: black;
        color: white;
      }
      #index {
        position: absolute;
        top: 1em;
        left: 1em;
        font-size: larger;
      }
      #gallery {
        height: 100vh;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }
      .nav-button--group {
        min-width: max-content;
        padding: 1em;
        font-size: larger;
      }
    </style>
  </head>
  <body>
    <a id="index" href="/zeke">Back to index</a>
    <div id="gallery">
      <a id="first" class="nav-button--group">&lt;&lt;first</a>
      <a id="prev" class="nav-button--group">&lt;prev</a>
      <!-- back button + image -->
      <img id="main" />
      <video id="alt" controls autoplay></video>
      <a id="next" class="nav-button--group">next &gt;</a>
      <a id="last" class="nav-button--group">last&gt;&gt;</a>
    </div>
    <script>
      function stringToTemplate(text) {
        const template = document.createElement("template");
        template.innerHTML = text;
        return template;
      }
      const [FirstLink, PrevLink, MainImg, MainVideo, NextLink, LastLink] = [
        "first",
        "prev",
        "main",
        "alt",
        "next",
        "last",
      ].map((id) => document.getElementById(id));
      const last = (arr) => arr.reverse()[0];
      const baseName = (url) => last(url.split("/"));
      const getExt = (filename) => last(filename.split("."));
      const imgExtensions = new Set(["png", "jpg", "jpeg"]);
      const videoExtensions = new Set(["mp4"]);
      const isImgUrl = (url) => imgExtensions.has(getExt(url));
      const isVideoUrl = (url) => videoExtensions.has(getExt(url));
      async function getImageHrefs() {
        return fetch(`${location.protocol}//${location.host}/zeke/index.html`)
          .then((response) => response.text())
          .then((text) => text.split("\n").slice(1).join("\n").trim()) // remove the DTD
          .then(stringToTemplate)
          .then((template) => Array.from(template.content.children))
          .then(
            (children) =>
              Array.from(children)
                .map((el) => Array.from(el.querySelectorAll("a[href]")))
                .filter((results) => Boolean(results.length))[0]
          )
          .then((links) =>
            links
              .map((a) => a.href)
              .filter((href) => isImgUrl(href) || isVideoUrl(href))
          );
      }
      const setUrlHash = (imgName) => {
        history.replaceState(
          null,
          document.title,
          `${location.pathname}#${imgName}`
        );
      };
      const setTitle = (imgName) =>
        (document.title = `Zeke gallery: ${imgName}`);

      const listenForArrowKeys = (incr, decr) => {
        document.addEventListener("keydown", (event) => {
          switch (event.key) {
            case "Enter":
            case "ArrowRight":
              return incr();
            case "ArrowLeft":
              return decr();
          }
        });
      };
      const index = (min = 0, max, initial = min, react) => {
        let value = initial;
        const set = (val) => {
          console.log({val})
          if (val <= max && val >= min) {
            value = val;
            react(value);
          }
        };
        const incr = () => set(value + 1);
        const decr = () => set(value - 1);

        react(value);
        return [set, incr, decr];
      };
      const hide = (el) => (el.style.display = "none");
      const show = (el) => (el.style.display = "block");
      const setHref = (el, href) => {
        if (href) el.href = `#${href}`;
        else if (Boolean(el.href)) el.attributes.removeNamedItem("href");
      };
      const setButtonLinks = (hrefs, index) => {
        const [prev = "", next = ""] = [
          hrefs[index - 1] || "",
          hrefs[index + 1] || "",
        ].map(baseName);
        setHref(PrevLink, prev);
        setHref(NextLink, next);
      };
      const setMainContent = (href) => {
        if (isImgUrl(href)) {
          MainImg.src = href;
          hide(MainVideo);
          show(MainImg);
        } else if (isVideoUrl(href)) {
          MainVideo.src = href;
          hide(MainImg);
          show(MainVideo);
        } else {
          throw new Error(`unexpected media: '${href}'`);
        }
      };
      getImageHrefs().then((hrefs) => {
        const react = (hrefIndex) => {
          const href = hrefs[hrefIndex];
          setMainContent(href);
          setButtonLinks(hrefs, hrefIndex);
          const imgName = baseName(href);
          setTitle(imgName);
          setUrlHash(imgName);
        };
        const hash = location.hash.replace(/^#/, "");
        let [min, max] = [0, hrefs.length - 1];
        const initial = Math.max(0, hrefs.map(baseName).indexOf(hash));
        const [set, incr, decr] = index(min, max, initial, react);
        FirstLink.href = "#" + baseName(hrefs[min]);
        LastLink.href = "#" + baseName(hrefs[max]);
        const onclick = (el, cb) => el.addEventListener("click", cb);
        onclick(FirstLink, () => set(min));
        onclick(LastLink, () => set(max));
        onclick(MainImg, incr)
        onclick(MainVideo, incr)
        onclick(NextLink, incr);
        onclick(PrevLink, decr);
        listenForArrowKeys(incr, decr);
        return hrefs;
      });
    </script>
  </body>
</html>
